version: '3'

services:
    nginx:
      build: ./nginx

      ports:
        - '31010:80'
      depends_on:
      - nextcloud01
      - nextcloud02
    nextcloud01:
      image: 'nextcloud:21.0.0-apache'

      restart: always
      volumes:
      - nextcloud:/var/www/html
      environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=password
      - MYSQL_HOST=mariadb
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=password
      depends_on: 
      - mariadb
    nextcloud02:
      image: 'nextcloud:21.0.0-apache'

      restart: always
      volumes:
      - nextcloud:/var/www/html
      environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=password
      - MYSQL_HOST=mariadb
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=password
      depends_on: 
      - mariadb
    mariadb:
      image: "mariadb:10.4.8-bionic"

      command: "--transaction-isolation=READ-COMMITTED --binlog-format=ROW"
      restart: always
      volumes:
      - db:/var/lib/mysql
      environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    openldap:
      image: larrycai/openldap
      ports:
        - '389:389'
        - '636:636'
      environment:
        - LDAP_ADMIN_USERNAME=admin
        - LDAP_ADMIN_PASSWORD=adminpassword
        - LDAP_USERS=user01,user02
        - LDAP_PASSWORDS=password1,password2

      volumes:
        - 'openldap_data:/bitnami/openldap'
volumes:
    openldap_data:
      driver: local
    nextcloud:
      driver: local 
    db:
      driver: local