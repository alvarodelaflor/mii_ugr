version: '3'

networks:
  app-tier:
    driver: bridge

services:
    nginx:
      build: ./nginx
      ports:
        - '80:8000'
      networks: 
        - app-tier
      depends_on: 
        - nextcloud01
        - nextcloud02
        - nextcloud03
    nextcloud01:
      image: "nextcloud:21.0.0-apache"
      ports:
      - '9001:80'
      restart: always
      volumes:
      - nextcloud:/var/www/html
      environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=password
      - MYSQL_HOST=mariadb
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=password
      depends_on: 
      - mariadb
      networks: 
      - app-tier
    nextcloud02:
      image: "nextcloud:21.0.0-apache"
      ports:
      - '9002:80'
      restart: always
      volumes:
      - nextcloud:/var/www/html
      environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=password
      - MYSQL_HOST=mariadb
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=password
      depends_on: 
      - mariadb
      networks: 
      - app-tier
    nextcloud03:
      image: "nextcloud:21.0.0-apache"
      ports:
      - '9003:80'
      restart: always
      volumes:
      - nextcloud:/var/www/html
      environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=password
      - MYSQL_HOST=mariadb
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=password
      depends_on: 
      - mariadb
      networks: 
      - app-tier   
    mariadb:
      image: "mariadb:10.4.8-bionic"
      command: "--transaction-isolation=READ-COMMITTED --binlog-format=ROW"
      restart: always
      volumes:
      - db:/var/lib/mysql
      networks: 
      - app-tier
      environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud         
volumes:
    nextcloud:
    db: